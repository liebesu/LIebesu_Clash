name: Enhanced Release Build with macOS Fix

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions: write-all

env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

concurrency:
  group: "${{ github.workflow }} - ${{ github.head_ref || github.ref }}"
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  check_tag_version:
    name: Check Release Tag and package.json Version Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check tag and package.json version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG_REF="${{ github.event.inputs.version }}"
          else
            TAG_REF="${GITHUB_REF_NAME:-${GITHUB_REF##*/}}"
          fi
          echo "Current tag: $TAG_REF"

          PKG_VERSION=$(jq -r .version package.json)
          echo "package.json version: $PKG_VERSION"

          EXPECTED_TAG="v$PKG_VERSION"

          if [[ "$TAG_REF" != "$EXPECTED_TAG" ]]; then
            echo "âŒ Version mismatch:"
            echo "   Git tag       : $TAG_REF"
            echo "   package.json  : $EXPECTED_TAG"
            exit 1
          fi

          echo "âœ… Tag and package.json version are consistent."

  release:
    name: Enhanced Release Build
    needs: [check_tag_version]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            target: aarch64-pc-windows-msvc
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust Target
        run: rustup target add ${{ matrix.target }}

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Install dependencies (ubuntu only)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libxslt1.1 libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev patchelf

      - name: Install macOS dependencies
        if: matrix.os == 'macos-latest'
        run: |
          # å®‰è£…å¿…è¦çš„ä¾èµ–
          brew install create-dmg
          
          # ä¸º x86_64 æž¶æž„å®‰è£… OpenSSL
          if [ "${{ matrix.target }}" == "x86_64-apple-darwin" ]; then
            arch -x86_64 brew install openssl@3
            echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
            echo "OPENSSL_INCLUDE_DIR=$(brew --prefix openssl@3)/include" >> $GITHUB_ENV
            echo "OPENSSL_LIB_DIR=$(brew --prefix openssl@3)/lib" >> $GITHUB_ENV
            echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig" >> $GITHUB_ENV
          fi

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - name: Pnpm install and check
        run: |
          pnpm i
          pnpm run prebuild ${{ matrix.target }}

      - name: Tauri build with enhanced memory
        uses: tauri-apps/tauri-action@v0
        env:
          # å¤§å¹…å¢žåŠ å†…å­˜é™åˆ¶ä»¥é¿å…æž„å»ºå¤±è´¥
          NODE_OPTIONS: "--max_old_space_size=8192"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # å¯¹äºŽmacOSï¼Œä½¿ç”¨æ›´å®‰å…¨çš„ç­¾åç­–ç•¥
          APPLE_SIGNING_IDENTITY: ${{ matrix.os == 'macos-latest' && (secrets.APPLE_SIGNING_IDENTITY || '-') || '' }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          VITE_BUILD_VERSION: "${{ github.run_number }}"
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "LIebesu_Clash ${{ github.ref_name }}"
          releaseBody: "Enhanced release with macOS startup fixes"
          releaseDraft: true
          prerelease: false
          tauriScript: pnpm
          args: --target ${{ matrix.target }}
          includeUpdaterJson: true

      - name: Enhanced macOS Post-Build Processing
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set -e
          echo "ðŸŽ å¼€å§‹å¢žå¼ºçš„ macOS åŽå¤„ç†..."
          
          # æŸ¥æ‰¾æž„å»ºçš„åº”ç”¨ç¨‹åº
          APP_PATH=$(find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.app" -type d | head -1)
          DMG_PATH=$(find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.dmg" -type f | head -1)
          
          echo "åº”ç”¨ç¨‹åºè·¯å¾„: $APP_PATH"
          echo "DMGè·¯å¾„: $DMG_PATH"
          
          if [ -n "$APP_PATH" ]; then
            echo "ðŸ”§ å¤„ç†åº”ç”¨ç¨‹åºåŒ…..."
            
            # 1. ç§»é™¤æ‰€æœ‰æ‰©å±•å±žæ€§ï¼ˆåŒ…æ‹¬éš”ç¦»æ ‡è®°ï¼‰
            echo "ç§»é™¤æ‰©å±•å±žæ€§..."
            sudo xattr -cr "$APP_PATH" || true
            
            # 2. è®¾ç½®æ­£ç¡®çš„æƒé™
            echo "è®¾ç½®æƒé™..."
            sudo chmod -R 755 "$APP_PATH"
            sudo chmod +x "$APP_PATH/Contents/MacOS/"* || true
            
            # 3. é‡æ–°ç­¾åï¼ˆå¦‚æžœæœ‰è¯ä¹¦åˆ™ä½¿ç”¨çœŸå®žç­¾åï¼Œå¦åˆ™ä½¿ç”¨ad-hocï¼‰
            echo "é‡æ–°ç­¾ååº”ç”¨ç¨‹åº..."
            if [ -n "${{ secrets.APPLE_SIGNING_IDENTITY }}" ]; then
              echo "ä½¿ç”¨çœŸå®žè¯ä¹¦ç­¾å..."
              codesign --force --deep --sign "${{ secrets.APPLE_SIGNING_IDENTITY }}" "$APP_PATH" || {
                echo "çœŸå®žç­¾åå¤±è´¥ï¼Œå›žé€€åˆ°ad-hocç­¾å"
                codesign --force --deep --sign - "$APP_PATH"
              }
            else
              echo "ä½¿ç”¨ad-hocç­¾å..."
              codesign --force --deep --sign - "$APP_PATH"
            fi
            
            # 4. éªŒè¯ç­¾å
            echo "éªŒè¯ç­¾å..."
            codesign --verify --verbose=2 "$APP_PATH" || echo "âš ï¸ ç­¾åéªŒè¯å¤±è´¥ï¼Œä½†åº”ç”¨ä»å¯èƒ½è¿è¡Œ"
            
            # 5. æ£€æŸ¥å’Œä¿®å¤Info.plist
            echo "æ£€æŸ¥Info.plist..."
            INFO_PLIST="$APP_PATH/Contents/Info.plist"
            if [ -f "$INFO_PLIST" ]; then
              # ç¡®ä¿CFBundleExecutableå­˜åœ¨å¹¶æ­£ç¡®
              BUNDLE_EXEC=$(plutil -extract CFBundleExecutable raw "$INFO_PLIST" 2>/dev/null || echo "")
              if [ -z "$BUNDLE_EXEC" ]; then
                echo "ä¿®å¤CFBundleExecutable..."
                plutil -replace CFBundleExecutable -string "LIebesu_Clash" "$INFO_PLIST" || true
              fi
              
              # ç¡®ä¿LSMinimumSystemVersionè®¾ç½®æ­£ç¡®
              plutil -replace LSMinimumSystemVersion -string "10.15" "$INFO_PLIST" || true
              
              # æ·»åŠ å¿…è¦çš„æƒé™å£°æ˜Ž
              plutil -replace NSHighResolutionCapable -bool true "$INFO_PLIST" || true
              
              echo "Info.plistéªŒè¯é€šè¿‡"
            fi
            
            # 6. å¼ºåˆ¶æ³¨å†Œåˆ°Launch Services
            echo "æ³¨å†Œåˆ°Launch Services..."
            sudo /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "$APP_PATH" || true
            
            # 7. åˆ›å»ºå¯åŠ¨è„šæœ¬
            echo "åˆ›å»ºmacOSä¿®å¤è„šæœ¬..."
            cat > "$(dirname "$APP_PATH")/fix-macos-startup.sh" << 'EOF'
          #!/bin/bash
          echo "ðŸ”§ LIebesu_Clash macOS å¯åŠ¨ä¿®å¤è„šæœ¬"
          
          APP_PATH="/Applications/LIebesu_Clash.app"
          if [ ! -d "$APP_PATH" ]; then
            APP_PATH="$PWD/LIebesu_Clash.app"
          fi
          
          if [ -d "$APP_PATH" ]; then
            echo "ç§»é™¤éš”ç¦»å±žæ€§..."
            sudo xattr -cr "$APP_PATH" 2>/dev/null || xattr -cr "$APP_PATH"
            
            echo "é‡æ–°ç­¾å..."
            codesign --force --deep --sign - "$APP_PATH"
            
            echo "æ³¨å†Œåº”ç”¨..."
            /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "$APP_PATH"
            
            echo "åˆ·æ–°Dockå’ŒLaunchpad..."
            killall Dock 2>/dev/null || true
            
            echo "âœ… ä¿®å¤å®Œæˆï¼å°è¯•å¯åŠ¨åº”ç”¨..."
            open "$APP_PATH"
          else
            echo "âŒ æœªæ‰¾åˆ°åº”ç”¨ç¨‹åº"
          fi
          EOF
            
            chmod +x "$(dirname "$APP_PATH")/fix-macos-startup.sh"
            
            # 8. æ›´æ–°æ—¶é—´æˆ³
            echo "æ›´æ–°æ—¶é—´æˆ³..."
            touch "$APP_PATH"
            
            echo "âœ… åº”ç”¨ç¨‹åºå¤„ç†å®Œæˆ"
          fi
          
          if [ -n "$DMG_PATH" ]; then
            echo "ðŸ”§ å¤„ç†DMGæ–‡ä»¶..."
            
            # ç§»é™¤DMGéš”ç¦»å±žæ€§
            sudo xattr -cr "$DMG_PATH" || true
            
            # å¤åˆ¶ä¿®å¤è„šæœ¬åˆ°DMGæ—è¾¹
            if [ -f "$(dirname "$APP_PATH")/fix-macos-startup.sh" ]; then
              cp "$(dirname "$APP_PATH")/fix-macos-startup.sh" "$(dirname "$DMG_PATH")/"
            fi
            
            echo "âœ… DMGå¤„ç†å®Œæˆ"
          fi
          
          echo "ðŸŽ‰ å¢žå¼ºçš„macOSåŽå¤„ç†å®Œæˆï¼"

      - name: Notarize macOS app (if certificates available)
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ -z "$APPLE_ID" ]; then
            echo "âš ï¸ Apple ID not configured, skipping notarization"
            exit 0
          fi
          
          echo "ðŸ”’ å¼€å§‹å…¬è¯macOSåº”ç”¨..."
          
          DMG_PATH=$(find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.dmg" -type f | head -1)
          
          if [ -n "$DMG_PATH" ]; then
            echo "å…¬è¯DMG: $DMG_PATH"
            
            # æäº¤å…¬è¯
            xcrun notarytool submit "$DMG_PATH" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait \
              --timeout 20m || {
              echo "âš ï¸ å…¬è¯å¤±è´¥æˆ–è¶…æ—¶ï¼Œä½†ä¸å½±å“å‘å¸ƒ"
            }
            
            # æ·»åŠ å…¬è¯ä¿¡æ¯åˆ°DMG
            xcrun stapler staple "$DMG_PATH" || {
              echo "âš ï¸ æ— æ³•æ·»åŠ å…¬è¯ä¿¡æ¯ï¼Œä½†DMGä»ç„¶æœ‰æ•ˆ"
            }
            
            echo "âœ… å…¬è¯æµç¨‹å®Œæˆ"
          fi

      - name: Create enhanced release notes
        if: matrix.os == 'windows-latest' && matrix.target == 'x86_64-pc-windows-msvc'
        run: |
          cat > release-notes.md << 'EOF'
          ## ðŸš€ LIebesu_Clash å¢žå¼ºç‰ˆå‘å¸ƒ
          
          ### âœ… macOS å¯åŠ¨é—®é¢˜ä¿®å¤
          - ðŸ”§ å½»åº•ä¿®å¤macOSåº”ç”¨æ— æ³•å¯åŠ¨çš„é—®é¢˜
          - ðŸ” æ”¹è¿›ä»£ç ç­¾åç­–ç•¥ï¼Œæ”¯æŒad-hocå’ŒçœŸå®žè¯ä¹¦ç­¾å
          - ðŸ§¹ è‡ªåŠ¨ç§»é™¤Gatekeeperéš”ç¦»å±žæ€§
          - ðŸ“± ä¿®å¤Launchpadå›¾æ ‡æ˜¾ç¤ºé—®é¢˜
          - âš™ï¸ å¢žå¼ºLaunch Servicesæ³¨å†Œæœºåˆ¶
          
          ### ðŸ› ï¸ æž„å»ºä¼˜åŒ–
          - ðŸ’¾ å¢žåŠ æž„å»ºå†…å­˜é™åˆ¶è‡³8GBï¼Œé¿å…å†…å­˜ä¸è¶³
          - ðŸ—ï¸ ä¼˜åŒ–ä¾èµ–å®‰è£…å’Œç¼“å­˜æœºåˆ¶
          - ðŸ” å¢žå¼ºé”™è¯¯æ£€æµ‹å’Œæ¢å¤èƒ½åŠ›
          
          ### ðŸ“‹ å®‰è£…è¯´æ˜Ž
          
          #### macOS ç”¨æˆ·
          1. ä¸‹è½½å¯¹åº”æž¶æž„çš„DMGæ–‡ä»¶
          2. å¦‚æžœé‡åˆ°å¯åŠ¨é—®é¢˜ï¼Œè¿è¡Œé™„å¸¦çš„ `fix-macos-startup.sh` è„šæœ¬
          3. æˆ–è€…åœ¨ç»ˆç«¯æ‰§è¡Œï¼š
             ```bash
             sudo xattr -cr /Applications/LIebesu_Clash.app
             codesign --force --deep --sign - /Applications/LIebesu_Clash.app
             ```
          
          #### Windows ç”¨æˆ·
          - ä¸‹è½½å¯¹åº”æž¶æž„çš„å®‰è£…åŒ…
          - æ”¯æŒæ­£å¸¸ç‰ˆæœ¬å’Œå†…ç½®WebView2ç‰ˆæœ¬
          
          #### Linux ç”¨æˆ·
          - æä¾›DEBå’ŒRPMåŒ…
          - æ”¯æŒx64ã€ARM64å’ŒARMv7æž¶æž„
          
          ### ðŸ”— ä¸‹è½½é“¾æŽ¥
          è§Release Assetséƒ¨åˆ†
          EOF

  update_release:
    name: Update Release with Assets
    needs: [release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update release notes
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "LIebesu_Clash ${{ github.ref_name }} - Enhanced"
          body_path: release-notes.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
