# 🔧 电报通知地址修复说明

## 🎯 问题描述

在自动构建过程中，电报通知发送的下载地址不正确：

**❌ 错误地址:**
```
https://github.com/liebesu/LIebesu_Clash/releases/download/autobuild/LIebesu_Clash_2.4.3+autobuild.0923.e84ccf7_aarch64.dmg
```

**✅ 正确地址:**
```
https://github.com/liebesu/LIebesu_Clash/releases/download/autobuild/LIebesu_Clash_2.4.3+autobuild.0923.e84ccf7_aarch64_41.dmg
```

**问题根源**: 文件名缺少运行编号后缀 `_41`，这是GitHub Actions的运行编号。

## 🛠️ 修复内容

### 1. **增强资产获取逻辑** (`scripts/telegram.mjs`)

#### 🔍 改进GitHub API调用
```javascript
// 使用更可靠的方式获取资产信息，包括完整的文件名
const assetsOutput = execSync(`gh api repos/liebesu/LIebesu_Clash/releases/tags/${releaseTag} --jq '.assets[] | .name' 2>/dev/null || echo ""`, { encoding: 'utf-8' });
releaseAssets = assetsOutput.trim().split('\n').filter(name => name.length > 0 && name !== '' && !name.includes('null'));

// 如果没有获取到资产，尝试其他方法
if (releaseAssets.length === 0) {
  log_info("尝试使用 gh release 命令获取资产列表");
  const releaseOutput = execSync(`gh release view ${releaseTag} --repo liebesu/LIebesu_Clash --json assets --jq '.assets[].name' 2>/dev/null || echo ""`, { encoding: 'utf-8' });
  releaseAssets = releaseOutput.trim().split('\n').filter(name => name.length > 0 && name !== '' && !name.includes('null'));
}
```

#### 🐛 增加调试信息
```javascript
// 调试信息：显示实际的文件名
if (releaseAssets.length > 0) {
  log_info("实际的资产文件名:");
  releaseAssets.forEach((asset, index) => {
    log_info(`  ${index + 1}. ${asset}`);
  });
}
```

#### 🔗 URL编码优化
```javascript
// 对文件名进行URL编码，确保包含特殊字符的文件名正确处理
const url = `https://github.com/liebesu/LIebesu_Clash/releases/download/${releaseTag}/${encodeURIComponent(asset)}`;
```

### 2. **改进构建流程** (`.github/workflows/autobuild.yml`)

#### ✅ 添加环境变量
```yaml
env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 新增
  BUILD_TYPE: autobuild
  VERSION: ${{ env.VERSION }}
  DOWNLOAD_URL: ${{ env.DOWNLOAD_URL }}
  TAG_NAME: ${{ env.TAG_NAME }}  # 新增
```

#### 🔧 添加调试步骤
```yaml
- name: Setup GitHub CLI
  run: |
    sudo apt-get update
    sudo apt-get install -y gh
    
- name: Debug Release Info
  run: |
    echo "=== 调试信息 ==="
    echo "TAG_NAME: $TAG_NAME"
    echo "VERSION: $VERSION"
    echo "DOWNLOAD_URL: $DOWNLOAD_URL"
    echo ""
    echo "=== 检查 GitHub Release ==="
    gh release view $TAG_NAME --repo liebesu/LIebesu_Clash || echo "Release 不存在"
    echo ""
    echo "=== 获取 Assets 列表 ==="
    gh api repos/liebesu/LIebesu_Clash/releases/tags/$TAG_NAME --jq '.assets[] | .name' || echo "无法获取 assets"
```

## 📊 修复效果

### ✅ 修复前后对比

| 方面 | 修复前 | 修复后 |
|------|--------|--------|
| **API调用** | 单一方法，可能失败 | 双重备份机制 |
| **文件名处理** | 可能获取不完整 | 完整文件名+URL编码 |
| **调试信息** | 基本日志 | 详细调试输出 |
| **错误处理** | 简单处理 | 多重容错机制 |
| **环境变量** | 部分缺失 | 完整配置 |

### 📈 技术改进

1. **🔒 可靠性提升**
   - 双重API调用机制
   - 更严格的文件名过滤
   - 完善的错误处理

2. **🔍 可观测性增强**
   - 详细的调试日志
   - 实时文件名显示
   - 构建过程状态监控

3. **🛡️ 容错性改进**
   - 多种获取方式
   - 编码安全处理
   - 环境变量完整性

## 🚀 验证方法

### 1. **本地验证**
```bash
# 测试前端构建
cd /Users/henry/enlink/code/ctf/ssr/clash-verge-rev
pnpm run web:build

# 验证脚本语法
node scripts/telegram.mjs --help
```

### 2. **构建验证**
在GitHub Actions中查看以下日志：
- ✅ "实际的资产文件名" 部分显示完整文件名
- ✅ 电报消息中的链接包含完整的文件名（含运行编号）
- ✅ 点击链接能正确下载文件

### 3. **预期效果**
电报消息将显示正确的下载链接：
```
**macOS**
- [Apple M芯片 DMG](https://github.com/liebesu/LIebesu_Clash/releases/download/autobuild/LIebesu_Clash_2.4.3+autobuild.0923.e84ccf7_aarch64_41.dmg)
```

## 💡 技术要点

### 🔧 关键修复点
1. **文件名获取**: 使用GitHub API正确获取包含运行编号的完整文件名
2. **URL构建**: 通过`encodeURIComponent()`确保文件名正确编码
3. **错误容错**: 双重API调用机制确保可靠性
4. **调试支持**: 详细日志便于问题排查

### 📝 注意事项
- GitHub Actions的运行编号（如`_41`）是动态生成的
- 需要确保`GITHUB_TOKEN`权限足够访问Release API
- 电报机器人需要有发送消息的权限
- 确保GitHub CLI在构建环境中可用

## 🎉 总结

此次修复解决了电报通知中下载链接不正确的问题，通过以下改进：

✅ **完善的文件名获取机制**  
✅ **可靠的错误处理逻辑**  
✅ **详细的调试信息输出**  
✅ **URL编码安全处理**  
✅ **多重容错备份方案**  

现在构建完成后，电报通知将发送**正确的下载地址**，用户点击链接即可正常下载文件。

---

**修复完成时间**: $(date)  
**影响范围**: 自动构建流程的电报通知功能  
**验证状态**: ✅ 代码修复完成，等待下次构建验证

