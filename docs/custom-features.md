# Custom Feature Reference (LIebesu_Clash)

This document captures every fork-specific enhancement so we can keep them intact while syncing with the upstream [`clash-verge-rev`](https://github.com/clash-verge-rev/clash-verge-rev) project.

## 1. 自研功能对照表

| 功能模块                   | 功能描述                                                                                                             | 关键目录 / 文件                                                                                                                                                                                                                                                                          | 主要提交（main 分支）                                                                                      | 依赖条件与注意事项                                                                                                                                  |
| -------------------------- | -------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| **品牌隔离与独立发布**     | 全面改名为 `LIebesu_Clash`，调整 bundle id、安装产物命名、系统图标，确保与官方版共存。                               | `src-tauri/Cargo.toml`, `src-tauri/tauri*.json`, `src-tauri/src/lib.rs`, `src-tauri/src/main.rs`, `icons/`, `scripts/generate-icons.sh`, `src/assets/image/logo*.svg`                                                                                                                    | `59a8c099`, `920b4d17`, `3d66f8b9`, `f900b154`, `3d66f8b9`                                                 | 依赖自定义图标素材，macOS 需要 `APPLE_SIGNING_IDENTITY` 占位签名；合并 upstream 时注意保留 bundle id、`productName`、DMG 重命名脚本。               |
| **批量订阅导入**           | 多步导入流程，支持剪贴板/文件、预览、去重、进度提示及错误报告。                                                      | `src/components/profile/batch-import-dialog.tsx`, `src/services/cmds/subscription-batch.ts`, `src-tauri/src/cmd/subscription_batch_manager.rs`                                                                                                                                           | `316639c7`, `94cd8bb2`, `0cc6495d`, `ab30ace5`, `62af1520`, `0db2e373`, `152d5370`, `e0bfe03c`             | 前端依赖 `@tauri-apps/plugin-dialog`、`@tauri-apps/plugin-fs`；Rust 使用 `serde_yaml_ng`, `reqwest`; 需要新增 Tauri `allowlist` 权限。              |
| **批量订阅导出**           | 将订阅批量导出到压缩包并预留导出路径选择。                                                                           | `src/components/profile/batch-export-dialog.tsx`, `src-tauri/src/cmd/subscription_batch_manager.rs`                                                                                                                                                                                      | `262bb097`, `62af1520`, `ab30ace5`, `0db2e373`                                                             | Rust 侧仍有 `TODO`（文件尺寸统计、节点数量限制），与导入共享 `subscription_batch_manager`；关注路径权限。                                           |
| **订阅分组与健康体检**     | UI 管理订阅分组、展示健康度并给出建议。                                                                              | `src/components/profile/subscription-groups-dialog.tsx`, `src-tauri/src/cmd/subscription_groups.rs`, `src-tauri/src/cmd/health_check.rs`                                                                                                                                                 | `94cd8bb2`, `316639c7`, `8697198a`, `820f09df`                                                             | 健康度数据目前部分模拟；依赖 `dashmap`、`chrono`；未来合并时关注 upstream 对订阅结构的改动。                                                        |
| **高级搜索**               | 支持多条件过滤，预留智能建议接口。                                                                                   | `src/components/profile/advanced-search-dialog.tsx`, `src-tauri/src/cmd/advanced_search.rs`                                                                                                                                                                                              | `744319db`, `94cd8bb2`, `8697198a`                                                                         | Rust 端包含 `TODO`，需确认 `serde` 模型；依赖 `regex`, `serde_json`。                                                                               |
| **流量分析增强**           | 增强图表展示、错误边界、汇总统计接口。                                                                               | `src/components/home/enhanced-traffic-stats.tsx`, `src/components/layout/layout-traffic.tsx`, `src/components/common/traffic-error-boundary.tsx`, `src-tauri/src/cmd/traffic_stats.rs`                                                                                                   | `94cd8bb2`, `820f09df`, `200555bf`, `8697198a`                                                             | Rust 指标采集尚未完整实现；与 upstream UI 合并时确保组件仍然引用增强版钩子。                                                                        |
| **任务调度器**             | 订阅批处理任务、后台队列、执行记录。                                                                                 | `src-tauri/src/cmd/task_manager.rs`, `src/components/profile/*` (任务入口按钮)                                                                                                                                                                                                           | `316639c7`, `8697198a`, `820f09df`, `b169f68c`                                                             | 依赖 `delay_timer`, `dashmap`, `tokio`；当前持久化为 `TODO`。                                                                                       |
| **备份 / WebDAV 同步雏形** | UI + 后端桩代码，为未来的备份与 WebDAV 同步铺路。                                                                    | `src/components/profile/backup-restore-dialog.tsx`, `src-tauri/src/cmd/backup_restore.rs`                                                                                                                                                                                                | `744319db`, `dc6279a1`, `8697198a`                                                                         | 仍未接入压缩与网络逻辑；需要系统读写权限及 WebDAV 凭据配置。                                                                                        |
| **全局节点测速增强**       | 多订阅并发测速、异常恢复、日志强化。                                                                                 | `0e6f41e3`, `5ba76116`, `b3886ef3`, `c5daedc2`, `66738203`, `3929192d`, `5147c665` 涉及的全部子模块：`src/components/profile/global-speed-test-dialog.tsx`, `src-tauri/src/cmd/speed_test/*.rs`                                                                                          | 详见提交 `0e6f41e3` 至 `5147c665` 序列                                                                     | Rust 依赖 `tokio`, `reqwest`, `dashmap`；涉及 Mihomo 内核调用，升级 upstream 内核时需逐条验证。                                                     |
| **自动构建流水线**         | GitHub Actions 自动打包、重命名产物、推送 Telegram 通知。                                                            | `.github/workflows/autobuild.yml`, `scripts/post-build-macos.sh`, `scripts/telegram.mjs`, `release.txt`, `scripts/prebuild.mjs`, `scripts/updatelog.mjs`                                                                                                                                 | `3dde7215`, `31fb71fb`, `6e50fdb4`, `ffeeeab6`, `e23822b9`, `a2aefc21`, `29f4b164`, `1da3c21e`, `e84ccf79` | 依赖 `pnpm`, `tauri-cli`, `gh` CLI、Telegram 机器人 token；默认仅构建 macOS ARM64，若恢复 Windows/Linux 需同步脚本。                                |
| **远程订阅列表管理**       | 支持配置远程 URL 列表（每行一个订阅），提供手动同步、预览统计与可选的定时刷新；集成批量导入/去重逻辑并更新同步日志。 | 前端：`src/components/setting/mods/subscription-fetch-viewer.tsx`<br>服务：`src-tauri/src/cmd/subscription_fetch.rs`, `src-tauri/src/config/subscription_fetch.rs`, `src-tauri/src/core/timer.rs`<br>配置：`src-tauri/src/config/verge.rs`, `src/services/cmds.ts`, `src/locales/*.json` | `待补录`                                                                                                   | 依赖 `reqwest` 网络访问（已存在），复用 `batch_import` 校验；定时任务使用 `remote-fetch-*` 自定义 UID，需确保定时器刷新逻辑在同步 upstream 时保留。 |

## 2. Sync & Merge Checklist

1. **Pull upstream updates** (`dev` branch) into `upstream-sync` as defined in `FORK_MAINTENANCE_STRATEGY.md`.
2. Compare the files listed above before merging; mark conflicts that touch:
   - Tauri configuration (`tauri.conf.json`, Windows/macOS overrides).
   - Rust `cmd` modules.
   - React profile components.
   - GitHub workflows.
3. Re-apply forked values (product names, identifiers, release URLs) if upstream overwrites them.
4. Run project checks:
   ```bash
   pnpm install --frozen-lockfile
   pnpm run prebuild
   pnpm tauri build --target aarch64-apple-darwin
   cargo fmt && cargo clippy --all-targets
   ```
5. Tag and push via existing `autobuild.yml` workflow or manual release scripts once verification passes.

## 3. Testing Notes

- **Frontend**: verify dialog flows (batch import/export, advanced search, traffic panel) still mount correctly after upstream layout changes.
- **Backend**: run targeted smoke tests by calling Tauri commands through `pnpm tauri dev`; watch `src-tauri/logs/app.log` for errors.
- **Workflows**: dry-run `autobuild.yml` with `workflow_dispatch` in a temporary branch before re-enabling additional build targets.

## 4. TODO Tracking

Several backend modules ship with explicit `TODO` markers (e.g., real WebDAV sync, task history persistence). Keep their status updated when implementing new logic; unresolved items are safe to leave as-is but should be revisited during major sync cycles.
