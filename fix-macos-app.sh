#!/bin/bash

# LIebesu_Clash macOS åº”ç”¨ä¿®å¤è„šæœ¬
# æ­¤è„šæœ¬ç”¨äºä¿®å¤ macOS ä¸Šçš„åº”ç”¨å®‰è£…å’Œå¯åŠ¨é—®é¢˜

set -e

APP_NAME="LIebesu_Clash.app"
APP_PATH="/Applications/$APP_NAME"

echo "ğŸ”§ LIebesu_Clash macOS ä¿®å¤è„šæœ¬"
echo "================================"

# æ£€æŸ¥åº”ç”¨æ˜¯å¦å­˜åœ¨
if [ ! -d "$APP_PATH" ]; then
    echo "âŒ æœªæ‰¾åˆ°åº”ç”¨ç¨‹åº: $APP_PATH"
    echo "è¯·å…ˆå®‰è£… LIebesu_Clash.dmg"
    exit 1
fi

echo "âœ… æ‰¾åˆ°åº”ç”¨ç¨‹åº: $APP_PATH"

# ç§»é™¤éš”ç¦»å±æ€§
echo "ğŸ§¹ ç§»é™¤éš”ç¦»å±æ€§..."
sudo xattr -cr "$APP_PATH" 2>/dev/null || {
    echo "âš ï¸  éœ€è¦ç®¡ç†å‘˜æƒé™æ¥ç§»é™¤éš”ç¦»å±æ€§"
    echo "è¯·è¾“å…¥å¯†ç ï¼š"
    sudo xattr -cr "$APP_PATH"
}

# é‡æ–°ç­¾ååº”ç”¨
echo "âœï¸  é‡æ–°ç­¾ååº”ç”¨..."
codesign --force --deep --sign - "$APP_PATH" 2>/dev/null || {
    echo "âš ï¸  é‡æ–°ç­¾åå¤±è´¥ï¼Œä½†åº”ç”¨å¯èƒ½ä»ç„¶å¯ä»¥è¿è¡Œ"
}

# éªŒè¯ç­¾å
echo "ğŸ” éªŒè¯ç­¾å..."
codesign --verify --verbose "$APP_PATH" 2>/dev/null && {
    echo "âœ… ç­¾åéªŒè¯æˆåŠŸ"
} || {
    echo "âš ï¸  ç­¾åéªŒè¯å¤±è´¥ï¼Œä½†åº”ç”¨å¯èƒ½ä»ç„¶å¯ä»¥è¿è¡Œ"
}

# è®¾ç½®æ­£ç¡®çš„æƒé™
echo "ğŸ” è®¾ç½®åº”ç”¨æƒé™..."
chmod -R 755 "$APP_PATH"

# å°è¯•å¯åŠ¨åº”ç”¨
echo "ğŸš€ å°è¯•å¯åŠ¨åº”ç”¨..."
open "$APP_PATH" && {
    echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸï¼"
    echo ""
    echo "å¦‚æœåº”ç”¨ä»ç„¶æ— æ³•æ­£å¸¸è¿è¡Œï¼Œè¯·å°è¯•ä»¥ä¸‹æ­¥éª¤ï¼š"
    echo "1. æ‰“å¼€ ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ > é€šç”¨"
    echo "2. ç‚¹å‡» 'ä»è¦æ‰“å¼€' æŒ‰é’®ï¼ˆå¦‚æœçœ‹åˆ° LIebesu_Clash ç›¸å…³æç¤ºï¼‰"
    echo "3. æˆ–è€…åœ¨ç»ˆç«¯ä¸­è¿è¡Œ: sudo spctl --master-disable"
    echo "   ï¼ˆè¿™ä¼šç¦ç”¨ Gatekeeperï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼‰"
} || {
    echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥"
    echo ""
    echo "è¯·å°è¯•ä»¥ä¸‹è§£å†³æ–¹æ¡ˆï¼š"
    echo "1. æ‰“å¼€ ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ > é€šç”¨"
    echo "2. å…è®¸ä»ä»»ä½•æ¥æºä¸‹è½½çš„åº”ç”¨ç¨‹åºè¿è¡Œ"
    echo "3. æˆ–è€…åœ¨ç»ˆç«¯ä¸­è¿è¡Œ:"
    echo "   sudo spctl --add '$APP_PATH'"
    echo "   sudo spctl --enable --label 'LIebesu_Clash'"
}

echo ""
echo "ğŸ”§ ä¿®å¤è„šæœ¬æ‰§è¡Œå®Œæˆ"